### Kafka实战

​		Kafka 是由 `Linkedin` 公司开发的，它是一**个分布式**的，支持**多分区、多副本**，基于 Zookeeper 的**分布式消息系统**，它同时也是一款**开源的基于发布订阅模式的消息引擎系统**，它的最大的特性就是可以实时的**处理大量数据以满足各种需求场景**：比如**基于hadoop的批处理系统**、**低延迟的实时系统**、storm/Spark**流式处理引擎**，web/**nginx日志**、**访问日志**，**消息服务**等等，用scala语言编写，Linkedin于2010年贡献给了Apache基金会并成为顶级开源 项目。

#### 1.kafka基础概念

###### 1.Kafka 基本术语

- **消息**：Kafka 中的数据单元被称为消息，也被称为**记录**，可以把它看作数据库表中**某一行的记录**。
- **批次**：为了提高效率， 消息会分批次写入 Kafka，批次就代指的是**一组消息**。
- **主题**：消息的种类称为**主题（Topic）**,可以说一个主题代表了一类消息。相当于是对消息进行分类。**主题就像是数据库中的表**。
- **分区**：主题可以被分为**若干个分区**（partition），同一个主题中的**分区可以不在一个机器上**，有可能会部署在多个机器上，由此来**实现 kafka 的伸缩性**，单一主题中的分区有序，但是**无法保证主题中所有的分区有序**。

<img src="/Users/xiaoxiangyuzhu/Pictures/Typora%20Images/image-20200320105637521.png" alt="image-20200320105637521" style="zoom:50%;" />

- **生产者**： 向**主题发布消息的客户端应用程序**称为生产者（Producer），生产者用于持续不断的向某个主题发送消息。
- **消费者**：**订阅主题消息的客户端程序称为消费者**（Consumer），消费者用于处理生产者产生的消息。
- **消费者群组**：生产者与消费者的关系就如同餐厅中的厨师和顾客之间的关系一样，一个厨师对应多个顾客，也就是**一个生产者对应多个消费者**，消费者群组（Consumer Group）指的就是由**一个或多个消费者组成的群体**。
    <img src="/Users/xiaoxiangyuzhu/Pictures/Typora%20Images/image-20200320105624144.png" alt="image-20200320105624144" style="zoom:50%;" />

- **偏移量**：偏移量（Consumer Offset）是一种元数据，它是一个**不断递增的整数值**，用来记录消费者发生**重平衡时的位置**，以便用来恢复数据。
- **broker**: 一个独立的 Kafka 服务器就被称为 broker，**broker 接收来自生产者的消息**，为消息设置**偏移量**，并提交消息到磁盘保存。
- **broker 集群**：broker 是集群的组成部分，broker 集群由**一个或多个 broker 组成**，每个集群都有一个 broker 同时充当了集群控制器的角色（自动从集群的活跃成员中选举出来）。
- **副本**：Kafka 中消息的备份又叫做**副本（Replica）**，副本的数量是可以配置的，Kafka 定义了两类副本：领导者副本（Leader Replica） 和 追随者副本（Follower Replica），前者**对外提供服务**，后者只是**被动跟随**。
- **重平衡**：Rebalance。消费者组内某个消费者实例**挂掉**后，其他消费者实例**自动重新分配订阅主题分区**的过程。Rebalance 是 Kafka 消费者端**实现高可用的重要手段**。



###### 2.Kafka 特性原则

- **高吞吐、低延迟**：kakfa 最大的特点就是**收发消息非常快**，kafka 每秒可以处理**几十万条消息**，它的最低延迟只有几毫秒。
- **高伸缩性**： 每个主题(topic) 包含**多个分区**(partition)，主题中的分区可以分布在不同的主机(broker)中。
- **持久性、可靠性**： Kafka 能够允许数据的持久化存储，消息被**持久化到磁盘**，并支持数据备份防止数据丢失，Kafka 底层的数据存储是**基于 Zookeeper 存储的**，Zookeeper 我们知道它的**数据能够持久存储**。
- **容错性**： 允许集群中的节点失败，某个节点宕机，Kafka 集群能够正常工作。
- **高并发**： 支持**数千个客户端同时读写**。

**kafka高效原理**：Kafka 实现了**零拷贝原理**来快速移动数据，避免了内核之间的切换。Kafka 可以将数据记录分批发送，**从生产者到文件系统（Kafka 主题日志）到消费者**，可以**端到端的查看**这些批次的数据。批处理能够进行更有效的**数据压缩并减少 I/O 延迟**，Kafka 采取**顺序写入磁盘**的方式，避免了随机磁盘寻址的浪费。总结一下其实就是四个要点

- **顺序读写**
- **零拷贝**
- **消息压缩**
- **分批发送**

###### 3.Kafka 使用场景

- **活动跟踪**：Kafka 可以用来跟踪用户行为，比如我们经常回去淘宝购物，你打开淘宝的那一刻，你的登陆信息，**登陆次数都会作为消息传输到 Kafka** ，当你浏览购物的时候，你的浏览信息，你的搜索指数，你的购物爱好都会作为一个个消息传递给 Kafka ，这样就可以**生成报告**，可以做**智能推荐，购买喜好**等。
- **传递消息**：Kafka 另外**一个基本用途是传递消息**，应用程序向用户发送通知就是通过传递消息来实现的，这些应用组件可以生成消息，而**不需要关心消息的格式**，也不需要关心消息**是如何发送**的。
- **度量指标**：Kafka也经常用来**记录运营监控数据**。包括收集各种**分布式应用的数据**，生产各种操作的集中反馈，比如报警和报告。
- **日志记录**：Kafka 的基本概念来源于**提交日志**，比如我们可以**把数据库的更新发送到 Kafka 上**，用来记录数据库的更新时间，**通过kafka以统一接口服务的方式开放给各种consumer**，如hadoop、Hbase、Solr等。
- **流式处理**：流式处理是有一个能够提供多种应用程序的领域。
- **限流削峰**：Kafka 多用于互联网领域某一时刻请求特别多的情况下，可以**把请求写入Kafka 中**，避免直接请求后端程序**导致服务崩溃**。



###### 4.Kafka 消息队列

Kafka 的消息队列一般分为两种模式：**点对点模式和发布订阅模式**

- **点对点模式：**Kafka 是支持**消费者群组的**，也就是说 Kafka 中会有**一个或者多个消费者**，如果一个生产者生产的消息由一个消费者进行消费的话，那么这种模式就是**点对点模式**；
- **发布-订阅模式：**如果一个生产者或者多个生产者产生的消息能够被**多个消费者同时消费的情况**，这样的消息队列成为发布订阅模式的**消息队列**。



###### 5.Kafka 系统架构

<img src="/Users/xiaoxiangyuzhu/Pictures/Typora%20Images/image-20200320111105441.png" alt="image-20200320111105441" style="zoom:50%;" />

​		Kafka通过Zookeeper**管理集群配置**，**选举leader**，以及在Consumer Group发生变化时进行**rebalance**。Producer使用**push模式将消息发布到broker**，Consumer使用**pull模式从broker订阅并消费**消息。一个典型的 Kafka 集群中包含：

- **若干Producer**（可以是web前端产生的**Page View**，或者是**服务器日志**，**系统CPU**、Memory等）
- **若干broker**（Kafka支持**水平扩展**，一般broker**数量越多，集群吞吐率越高**）
- **若干Consumer Group**
- **一个Zookeeper集群**


###### 6.kafka 核心 API

Kafka 有四个核心API，它们分别是

- **Producer API**，它允许应用程序向**一个或多个 topics 上发送消息记录**。
- **Consumer API**，允许应用程序**订阅一个或多个 topics 并处理为其生成的记录流**。
- **Streams API**，它允许应用程序作为**流处理器**，从一个或多个主题中**消费输入流并为其生成输出流**，有效的**将输入流转换为输出流**。
- **Connector API**，它允许构建和运行将 Kafka 主题**连接到现有应用程序或数据系统**的可用生产者和消费者。例如，关系数据库的连接器可能会捕获对表的所有更改。

<img src="/Users/xiaoxiangyuzhu/Pictures/Typora%20Images/image-20200320112109908.png" alt="image-20200320112109908" style="zoom:50%;" />